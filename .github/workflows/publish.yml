name: Build and Publish npm

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write   # <--- This is the key requirement for OIDC!
  contents: read    # Required to checkout the code

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: https://harryv1.jfrog.io
        with:
          oidc-provider-name: github-oidc  # Matches your Integration Name
          oidc-audience: jfrog-github      # Matches your Audience

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Config and Publish
        run: |
          # 1. Configure npm (for dependency resolution)
          jf npm-config --global --repo-resolve=harryv-npm --repo-deploy=harryv-npm

          # 2. Bump version
          npm version patch --no-git-tag-version

          # 3. Publish using JFrog CLI (This is the fix!)
          # We explicitly verify the build and upload to Artifactory
          jf npm publish --build-name="Build and Publish npm" --build-number=$GITHUB_RUN_NUMBER
          
          # 4. Publish Build Info (Optional but recommended for OIDC visibility)
          jf rt build-publish "Build and Publish npm" $GITHUB_RUN_NUMBER
